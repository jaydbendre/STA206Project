---
title: "causal_inference"
author: "Collin"
date: "12/2/2021"
output: html_document
---

```{r}
# http://sekhon.berkeley.edu/matching/lalonde.html description of the dataset
#AER article where the dataset is from https://business.baylor.edu//scott_cunningham/teaching/lalonde-1986.pdf
knitr::opts_chunk$set(echo = TRUE)
#install.packages("qte")
library(qte)
library(dplyr)
library(ggplot2)
library(tidyr)
library(PerformanceAnalytics)
library(gridExtra)
library(MASS)
work_training_df = lalonde.exp
head(work_training_df)
dim(work_training_df)
```

# Exploratory Data Analysis
```{r}
work_training_df %>% 
  group_by(treat) %>% 
  summarise(count = n())
  

#Look at earnings for both groups in 75 and 78

plot_data = work_training_df %>% 
  pivot_longer(cols = c(re75,re78), names_to = "earnings_year",values_to = "earnings")

plot_data %>% 
  group_by(treat,earnings_year) %>% 
  summarise(average_earnings = mean(earnings))

plot_data

ggplot(data = plot_data, mapping = aes(x = earnings_year, y = earnings, fill = as.factor(treat)))+
  geom_boxplot()+
  theme_minimal()+
  ylim(c(0, 20000)) + 
  ggtitle("Box Plot: Earnings in 1975 and 1978", subtitle = "comparison between control and treatment groups")
  
```

We can see that clearly the earnings are higher for the people who recieved the treatment.

```{r}
colSums(is.na(work_training_df))
```

There are no NA values in the dataset.

```{r}
sapply(work_training_df, class)
```

The variable "treat" needs to be converted to a factor.


```{r}
# convert variables to factors
work_training_df$treat <- as.factor(work_training_df$treat)
work_training_df$black <- as.factor(work_training_df$black)
work_training_df$hispanic <- as.factor(work_training_df$hispanic)
work_training_df$married <- as.factor(work_training_df$married)
work_training_df$nodegree <- as.factor(work_training_df$nodegree)
work_training_df$u74 <- as.factor(work_training_df$u74)
work_training_df$u75 <- as.factor(work_training_df$u75)
sapply(work_training_df, class)
```

```{r}
sort(unique(work_training_df$education))

encode <- function(col) {
  if (col %in% c(3:8)) {
    return(0)
  } else if (col %in% c(9:12)) {
    return(1)
  } else {
    return(2)
  }
}
work_training_df$education =  as.factor(sapply(work_training_df$education,encode))
work_training_df
```

0 = elementary or middle school
1 = high school
2 = college


```{r}
ggplot(data = work_training_df, mapping = aes(x = treat, y = re78, fill = education))+
  geom_boxplot()+
  theme_minimal() + 
  ylim(c(0,20000))
  
  #ggtitle("Box Plot: Earnings in 1975 and 1978", subtitle = "comparison between control and treatment groups")
```

```{r}
filtered_df_0 <- work_training_df %>% filter(treat == 0)
filtered_df_1 <- work_training_df %>% filter(treat == 1)

p1 <- ggplot(data = filtered_df_0, aes(re78)) + 
  geom_histogram()

p2 <- ggplot(data = filtered_df_1, aes(re78)) + 
  geom_histogram()

grid.arrange(p1, p2, nrow=1)
```


```{r}
p1 <- ggplot(data = work_training_df, aes(age)) + 
  geom_histogram()

p2 <- ggplot(data = work_training_df, aes(re78)) + 
  geom_histogram()

grid.arrange(p1, p2, nrow=1)
```

```{r}
colnames(work_training_df)
```


```{r}
sample_training_df <- work_training_df %>% dplyr::select(-id)
m1 <- lm(re78 ~ ., data = sample_training_df)
summary(m1)
```

Could be mainly due to a large number of indicator variables. Might be a good call to center it.

```{r fig, fig.height=10, fig.width = 10}
# Maybe scaling the data would help?
sample_training_df <- sample_training_df %>% select_if(is.numeric) 

sample_training_df_scaled <- work_training_df %>% mutate_if(is.numeric,scale)
#sample_training_df_scaled$re78 <- unscale(sample_training_df_scaled$re78)
# Checking for any obvious patterns
pairs(sample_training_df_scaled)

# scatterplotmatrix
chart.Correlation(sample_training_df_scaled %>% select_if(is.numeric))
```

```{r}
work_training_df$re78[work_training_df$re78 == 0] <- 0.0001
work_training_df
```

There seems to be no obvious patterns

```{r}
work_training_df_exp <- lalonde.exp
work_training_df_exp$re78.transformed <- sqrt(1 + work_training_df_exp$re78)
hist(work_training_df_exp$re78.transformed, breaks = 30)
```

```{r}

work_training_df_exp$re78.transformed1 <- work_training_df_exp$re78 + mean(work_training_df_exp$re78)
hist(work_training_df_exp$re78.transformed1,breaks = 30)
boxcox(work_training_df$re78.transformed1~., data = work_training_df_exp %>% dplyr::select(-c("re78","re78.transformed")))


m_test = lm(re78.transformed1 ~ ., data = work_training_df_exp %>% dplyr::select(-c("re78","re78.transformed")))
m_test.summary = summary(m_test)
m_test.summary
plot(m_test)

bc <- boxcox(re78.transformed1~., data = work_training_df_exp %>% dplyr::select(-c("re78","re78.transformed")))

(lambda <- bc$x[which.max(bc$y)])
work_training_df_exp$re78.transformed1 <- ((work_training_df_exp$re78.transformed1 ^ lambda) -1)/lambda
```

```{r}
m1_star<- lm(re78 ~., data = sample_training_df_scaled)
summary(m1_star)
```


```{r}
#sample_training_df_scaled <- sample_training_df_scaled %>% dplyr::select(-c("id"))
#colnames(sample_training_df_scaled)
m0 <- lm(re78 ~ 1, data = sample_training_df_scaled)
m_full <- lm(re78 ~ .^2, data = sample_training_df_scaled)

forward.aic <- stepAIC(m0, scope = list(lower = m0, upper = m_full), direction = "both", k = 2, trace = 0)

forward.aic$anova
<<<<<<< HEAD
summary(forward.aic)
```
=======
```


```{r}
model2 <- lm(re78 ~ re75 + re74 + education + age + u74 + hispanic + married + 
    re75:re74 + re75:u74 + re75:education + u74:married + re74:married + 
    re74:age + re75:age + re74:education + treat, data = work_training_df)
summary(model2)
```

```{r}
boxcox(model2)
```

```{r}
model2 <- lm(re78 ~ re75 + re74 + education + age + u74 + hispanic + married + 
    re75:re74 + re75:u74 + re75:education + u74:married + re74:married + 
    re74:age + re75:age + re74:education + treat, data = work_training_df)
summary(model2)
```


```{r, fig, fig.height=5, fig.width=10}
par(mfrow=c(1,2))
plot(model2, which = 1)
plot(model2, which = 2)
```

```{r}
hist(sqrt(work_training_df$re78))
```

>>>>>>> f383975606f9327f471e8dd9c084aaf3c13b7244
